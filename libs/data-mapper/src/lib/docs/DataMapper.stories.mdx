import { Meta } from '@storybook/addon-docs';

<Meta title="Docs/Data Mapper" />

# Data Mapper (VS Code / Portal)

## Architecture

### Purpose

To provide a graphical way to map data from an input schema to an output schema using direct mappings and expressions, handling any translation between supported schema types in the backend

### Data Flow

From a fresh start, the data we handle translates/transforms in the following flow:

1. .xsd (XML) Schemas
2. Backend - getSchemaTree (takes any supported schema format and returns it as JSON)
3. Internal state management of schema/schemaExtended
4. onSave - data map definition saved as .yml, and .xslt generated by backend and saved

## VS Code Extension

### Prereqs

Make sure you've git-cloned and npm-installed-in the logic_apps_designer repo

### Build

To build, run the following commands in order (from the root of the repo folder):

```bash
nx build vs-code-data-mapper
```

```bash
nx build vs-code-data-mapper-react
```

### Run

To run the VS Code extension (in debug mode), ensure you have the repo folder opened in VS Code,
then click the 'Run and Debug' tab on the left (Activity) bar. Make sure 'Run Data Mapper Extension...'
is selected in the dropdown at the top, then click the 'Start debugging' icon

In order to connect to the backend, ensure that you run the 'Start: Azurite' command and click 'Run -> Run Without Debugging' after starting the extension

### Functionality

The extension activates/initializes automatically upon viewing the Azure Tools extension tree, or by having a Logic Apps workflow folder open in your VS Code workspace

- Context menu - load data map
- Azure Tools view - create new data map
- Within Data Mapper component - ConfigPane (choosing schemas) for existing schema files; save data maps to filesystem

## Backend

Data Mapper UX relies on its backend for the following:

- Schema translation (getSchemaTree - translates any supported schema format to JSON)
  - Ex: http://localhost:7071/runtime/webhooks/workflow/api/management/schemas/CBRInputSchema/contents/schemaTree?api-version=2019-10-01-edge-preview
- .XSLT generation (formats a data map with all of its nodes/expressions/connections into a common .xslt format)
- Testing connections (ensuring that any connections, including expressions, produce the expected output)

### Set-up (7 SEPT 2022)

#### Prerequisites

- .NET Core SDK 3.1
- Azure Functions Core Tools (https://github.com/Azure/azure-functions-core-tools or `npm i -g azure-functions-core-tools --unsafe-perm true`)
- VS Code Extensions: Azure Tools, Azure Logic Apps (Standard)

- Logic Apps workflow (folder - w/ schemas) - see steps to create below:

1. In Azure Tools extension tab under Logic Apps (Standard), click the 'Create New Project' icon, and choose where you want the project folder
2. Make sure that ./Artifacts/Schemas exists in the newly created project folder, and add an .xsd template schema for testing (ask Reid/Danielle)
3. With that folder still open in your VS Code workspace, go back to Logic Apps (Standard) and click 'Create New Workflow' -> Stateless -> Enter

#### Running dev-build backend runtime

The backend runtime will now start and configure any necessary settings as the extension loads, so all you have to do (for dev) is:

1. Run `func host start` in your terminal so we can generate the necessary paths/folder for the next step (you should only have to do this step the very first time)
2. Ask Reid/Danielle for the backend runtime .zip, download it, go to yourRootUsernameFolder/.azure-functions-core-tools/Functions/ExtensionBundles/Microsoft.Azure.Functions.ExtensionBundle.Workflows,
   back up the current version, then replace it with the files just downloaded (renaming it to the same version as the one you replaced)
3. You can now run Data Mapper with its latest backend runtime!
