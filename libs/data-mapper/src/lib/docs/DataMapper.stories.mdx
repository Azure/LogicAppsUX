import { Meta } from '@storybook/addon-docs';

<Meta title="Docs/Data Mapper" />

# Data Mapper (VS Code / Portal)

## Architecture

### Purpose

To provide a graphical way to map data from an input schema to an output schema using direct mappings and expressions, handling any translation between supported schema types in the backend

### Data Flow

From a fresh start, the data we handle translates/transforms in the following flow:

1. .xsd (XML) Schemas
2. Backend - getSchemaTree (takes any supported schema format and returns it as JSON)
3. Internal state management of schema/schemaExtended
4. onSave - data map definition saved as .yml, and .xslt generated by backend and saved

## VS Code Extension

### Prereqs

Make sure you've git-cloned and npm-installed-in the logic_apps_designer repo

### Build

To build, run the following commands in order (from the root of the repo folder):

```bash
nx build vs-code-data-mapper
```

```bash
nx build vs-code-data-mapper-react
```

### Run

To run the VS Code extension (in debug mode), ensure you have the repo folder opened in VS Code,
then click the 'Run and Debug' tab on the left (Activity) bar. Make sure 'Run Data Mapper Extension...'
is selected in the dropdown at the top, then click the 'Start debugging' icon

In order to connect to the backend, ensure that you run the 'Start: Azurite' command and click 'Run -> Run Without Debugging' after starting the extension

### Functionality

The extension activates/initializes automatically upon viewing the Azure Tools extension tree, or by having a Logic Apps workflow folder open in your VS Code workspace

- Context menu - load data map
- Azure Tools view - create new data map
- Within Data Mapper component - ConfigPane (choosing schemas) for existing schema files; save data maps to filesystem

## Backend

Data Mapper UX relies on its backend for the following:

- Schema translation (getSchemaTree - translates any supported schema format to JSON)
- .XSLT generation (formats a data map with all of its nodes/expressions/connections into a common .xslt format)
- Testing connections (ensuring that any connections, including expressions, produce the expected output)

### Set-up (31 AUG 2022)

1. Install VS Code extensions: Azure Tools, Azure Logic Apps (Standard), Azurite, .NET Watch Attach
2. Download and install Azure Functions Core Tools v3 (https://github.com/Azure/azure-functions-core-tools or npm i -g azure-functions-core-tools@3 --unsafe-perm true)
3. Make sure you have .NET Core SDK 3.1 installed
4. In Azure Tools extension tab under Logic Apps (Standard), click the 'Create New Project' icon, and choose where you want the project folder
5. Make sure that ./Artifacts/Schemas exists in the newly created project folder, and add an .xsd template schema for testing (ask Reid/Danielle)
6. With that folder still open in your VS Code workspace, go back to Logic Apps (Standard) and click 'Create New Workflow' -> Stateless -> Enter
7. Configure the following: local.settings.json - under values, add "AzureWebJobsStorage": "UseDevelopmentStorage=true" |||| .vscode/settings.json - make sure azureLogicAppsStandard.projectRuntime is '~3'
8. Start Azurite ('Azurite: Start' in the command palette)
9. **Windows:** In the VS Code title bar, click Run -> Run Without Debugging - this will generate the necessary path/files for the next step  
   **Mac:** Run `func host start` in your terminal
10. Ask Reid/Danielle for the backend runtime .zip, download it, go to C:/Users/yourUsername/.azure-functions-core-tools/Functions/ExtensionBundles/Microsoft.Azure.Functions.ExtensionBundle.Workflows,
    back up the current version, then replace it with the files just downloaded (renaming it to the same version as the one you replaced)
11. Repeat step 9 (Run -> Run Without Debugging), and you should now be able to hit the below endpoint(s)
12. To hit the (get)schemaTree endpoint: http://localhost:7071/runtime/webhooks/workflow/api/management/schemas/CBRInputSchema/contents/schemaTree?api-version=2019-10-01-edge-preview
