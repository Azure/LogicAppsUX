name: Playwright Tests - Nightly
on:
  push:
    branches: [e2eTesting]


jobs:

  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
        issues: write
        pull-requests: write
        id-token: write
    steps:
    - uses: actions/checkout@v4

    - name: Open Token Directory
      working-directory: apps/Standalone/src/environments/jsonImport
      run: |
        ls -la

    - name: Azure login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_TESTING_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TESTING_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_TESTING_SUBSCRIPTION_ID }}
        enable-AzPSSession: true 



    - name: "extract AAD access token for MSI (valid for about an hour)"
      run: |
        az account get-access-token --tenant 72f988bf-86f1-41af-91ab-2d7cd011db47 >> apps/Standalone/src/environments/jsonImport/armToken.json

   
    - uses: pnpm/action-setup@v3
      with:
        version: 8
        run_install: |
          - recursive: true
            args: [--frozen-lockfile, --strict-peer-dependencies]

    - name: Deploy Logic Apps For Testing
      uses: azure/cli@v2
      with:
        azcliversion: 2.30.0
        inlineScript: |
            az deployment group create \
            --resource-group LAE2ETESTING \
            --subscription ${{ secrets.AZURE_TESTING_SUBSCRIPTION_ID }} \
            --template-file ./e2e/testSetup/BlankLogicApp/logicAppStandard.bicep

    - name: Install Playwright Browsers
      run: pnpm run e2e:setup
    - name: Run Playwright tests
      run: pnpm run test:e2e --grep @real
    - name: Scrub Secrets From Trace
      run: pnpm run scrub-secrets:e2e

    - name: "extract AAD access token for MSI (valid for about an hour)"
      shell: bash
      run: |
        REPORT_DIR='run-${{ github.run_id }}-${{ github.run_attempt }}'
        az storage blob upload-batch --account-name lauxtestreport --auth-mode key -d '$web/$REPORT_DIR' -s "./playwright-report"
        echo "::notice title=HTML report url::https://lauxtestreport.z1.web.core.windows.net/$REPORT_DIR/index.html"
 
    # - name: Upload HTML report to Azure
    #   shell: bash
    #   run: |
    #     REPORT_DIR='run-${{ github.run_id }}-${{ github.run_attempt }}'
    #     azcopy cp --recursive "./playwright-report/*" "https://lauxtestreport.blob.core.windows.net/\$web/$REPORT_DIR"
    #     echo "::notice title=HTML report url::https://lauxtestreport.z1.web.core.windows.net/$REPORT_DIR/index.html"
    #   env:
    #     AZCOPY_AUTO_LOGIN_TYPE: SPN
    #     AZCOPY_SPA_APPLICATION_ID: '${{ secrets.AZURE_TESTING_CLIENT_ID }}'
    #     AZCOPY_SPA_CLIENT_SECRET: '${{ secrets.AZCOPY_SPA_CLIENT_SECRET }}'
    #     AZCOPY_TENANT_ID: '${{ secrets.AZCOPY_TENANT_ID }}'

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30