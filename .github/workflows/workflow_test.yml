name: workflow_test
run-name: Production Build - ${{ github.event.inputs.release_type || 'no_type_specified' }}
on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'minor'
        type: choice
        options:
          - major
          - minor
          - patch
  repository_dispatch:
    types: [release]
  schedule:
    - cron: '0 17 * * 4'

env:
  AI_KEY: 3cf0d6ae-3327-414a-b7c1-12f31ef45eff
  NX_AI_CON_STR: InstrumentationKey=3cf0d6ae-3327-414a-b7c1-12f31ef45eff;IngestionEndpoint=https://eastus-8.in.applicationinsights.azure.com/;LiveEndpoint=https://eastus.livediagnostics.monitor.azure.com/
  BUMP_COMMAND: pnpm run bump --release-as ${{ github.event.inputs.release_type || 'minor' }}

jobs:
  validation:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch and release type
        id: validate
        run: |
          BRANCH_NAME=$(echo "${{ github.ref_name }}" | awk -F'/' '{print $NF}')
          echo "Branch: $BRANCH_NAME"
          
          if [[ "$BRANCH_NAME" == "main" && "${{ github.event.inputs.release_type }}" == "patch" ]]; then
            echo "Patch releases are not allowed on the main branch."
            exit 1
          fi

          if [[ "$BRANCH_NAME" != "main" && "${{ github.event.inputs.release_type }}" != "patch" ]]; then
            echo "Major and minor releases are only allowed on the main branch."
            exit 1
          fi
